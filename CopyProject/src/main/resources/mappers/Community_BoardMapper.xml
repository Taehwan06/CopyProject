<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="edu.study.mapper.Community_boardMapper">
	<!-- 본문 가져오기 -->
	<select id="Comm_listBoard" resultType="Community_boardVO" parameterType="SearchVO">		
         SELECT cbidx,
         		title,
         		writer,
         		scrap_cnt,
         		hit_cnt,
         		img_system,
         		profile_system
           FROM community_board c
           INNER JOIN member m
           ON c.midx = m.midx 
          WHERE 1=1
          AND c.del_yn = 'N'
            ORDER BY cbidx DESC
    </select>
    
    <!-- 작성 시간 가져오기 -->
    <select id="writeday" resultType="String">
    <![CDATA[
    	SELECT
    	CASE
    		WHEN TIMESTAMPDIFF(MINUTE, (select write_date from community_board where cbidx=#{cbidx}), NOW()) <= 0 THEN '방금 전'
		    WHEN TIMESTAMPDIFF(MINUTE, (select write_date from community_board where cbidx=#{cbidx}), NOW()) < 60 THEN CONCAT(TIMESTAMPDIFF(MINUTE, (select write_date from community_board where cbidx=#{cbidx}), NOW()), '분 전')
		    WHEN TIMESTAMPDIFF(HOUR, (select write_date from community_board where cbidx=#{cbidx}), NOW()) < 24 THEN CONCAT(TIMESTAMPDIFF(HOUR, (select write_date from community_board where cbidx=#{cbidx}), NOW()), '시간 전')
		    WHEN TIMESTAMPDIFF(DAY, (select write_date from community_board where cbidx=#{cbidx}), NOW()) < 30 THEN CONCAT(TIMESTAMPDIFF(DAY, (select write_date from community_board where cbidx=#{cbidx}), NOW()), '일 전')
		    ELSE CONCAT(TIMESTAMPDIFF(MONTH, (select write_date from community_board where cbidx=#{cbidx}), NOW()), '달 전')
		END AS AGOTIME
		FROM community_board
		WHERE cbidx=#{cbidx}
	]]>
    </select>
    
    <!-- 전체 글 개수 -->
    <select id="Comm_listcnt" resultType="int">
    	SELECT count(*) as listCnt
    	FROM community_board
    	WHERE del_yn = 'N'
    </select>
    
    <!-- 본문 커버사진 -->
    <select id="Comm_mainImg" resultType="Community_boardVO">
    	SELECT cbidx,
    		   title,
    		   writer,
    		   img_system,
    		   profile_system
    	FROM community_board c
        INNER JOIN member m
        ON c.midx = m.midx
    	WHERE hit_cnt = (
    	SELECT hit_cnt
    	FROM community_board
    	ORDER BY hit_cnt DESC
    	LIMIT 1)
    	AND c.del_yn = 'N'
    	ORDER BY cbidx DESC
    	LIMIT 1
    </select>
    
    <!-- 본문 상세보기 -->
    <select id="Comm_detailBoard" resultType="Community_boardVO" parameterType="int">
    	 SELECT cbidx,
				title,
         		content,
         		writer,
         		write_date,
         		scrap_cnt,
         		reply_cnt,
         		img_origin,
         		img_system,
         		hit_cnt,
         		c.midx,
         		profile_system
          FROM community_board c
          INNER JOIN member m
          ON c.midx = m.midx
          WHERE cbidx= #{cbidx}
    </select>
    
    <!-- 본문 수정하기 -->
    <update id="Comm_updateBoard" parameterType="Community_BoardVO">
    	UPDATE community_board
    	   SET title = #{title}
    		  ,content = #{content}
         WHERE cbidx = #{cbidx}
    </update>
    
    <!-- 본문 삭제하기 -->
    <update id="Comm_deleteBoard" parameterType="int">
    	UPDATE community_board
    	   SET del_yn = 'Y'
    	 WHERE cbidx = #{cbidx}
    </update>
    
    <!-- 본문 글 작성 -->
    <insert id="Comm_insertBoard" parameterType="Community_BoardVO">
    <![CDATA[
    	INSERT INTO community_board(
    		title,
    		content,
    		writer,
    		midx,
    		img_origin,
    		img_system
    	) VALUES(
    		#{title},
    		#{content},
    		#{writer},
    		#{midx},
    		#{img_origin},
    		#{img_system}
    	)
    ]]>
    <selectKey resultType="int" keyProperty="cbidx" order="AFTER">
    	SELECT MAX(cbidx)
    	  FROM community_board
    </selectKey>
    </insert>
    
    <!-- 마지막 댓글 번호 -->
    <select id="cbridx" resultType="int">
    	SELECT MAX(cbridx)
    	FROM community_reply
    </select>
    
</mapper>